import argparse
from copy import copy

from prettytable import PrettyTable

from plugins.TCloud import PluginTencentCloudBase, TencentAPi
from utils import output
from utils.consts import AllPluginTypes


class PluginTCloudGetLHInstance(PluginTencentCloudBase):
    display = "列出轻量应用服务器实例"
    alias = "t_get_lh"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display
        parser.add_argument("-a", "--secret-id", required=True, help="secret id", dest="access_key")
        parser.add_argument("-s", "--secret-key", required=True, help="secret key", dest="secret_key")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        tapi = TencentAPi(args.access_key, args.secret_key)
        region_lists = tapi.get_all_regions()

        lh_lists = tapi.get_lh_instance(region_lists)

        table = PrettyTable(["Os Name",
                             "Instance ID", "Instance Name", "Instance State", "Platform",
                             "Create Time", "Expired Time",
                             "Private Address", "Public Address", "Zone"])
        # table.border = False
        #
        for l in lh_lists:
            table.add_row([l.OsName, l.InstanceId, l.InstanceName, l.InstanceState, l.Platform,
                           l.CreatedTime, l.ExpiredTime, l.PrivateAddresses, l.PublicAddresses, l.Zone])
        output.success(f"result:\n"
                       f"{table}")

        return result
