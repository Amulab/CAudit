import argparse
import random
import time
from copy import copy

import oss2
import requests
from prettytable import PrettyTable

from plugins.AliCloud import PluginAliCloudBase, AliCloud
from utils import output
from utils.consts import AllPluginTypes


class PluginAliCloudCreateBucket(PluginAliCloudBase):
    display = "创建OSS存储空间"
    alias = "ali_cret_bucket"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display
        parser.add_argument("-a", "--access-key", required=True, help="access key", dest="access_key")
        parser.add_argument("-s", "--secret-key", required=True, help="secret key", dest="secret_key")
        parser.add_argument("-n", "--bucket-name", required=True, help="bucket name", default="bucket_name")
        parser.add_argument("-r", "-region-id", required=True, help="region id.(cn-hangzhou)", dest="region_id")
        parser.add_argument("-c", "--acl", required=False, help="bucket acl, default is private. private(p)/public_read(r)/public_read_write(w)",
                            choices=["p", "r", "w"],default="p", dest="acl")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        oss_acl = {
            "p": oss2.BUCKET_ACL_PRIVATE,
            "r": oss2.BUCKET_ACL_PUBLIC_READ,
            "w": oss2.BUCKET_ACL_PUBLIC_READ_WRITE
        }

        auth = oss2.Auth(args.access_key, args.secret_key)
        bucket = oss2.Bucket(auth, f'https://oss-{args.region_id}.aliyuncs.com', args.bucket_name)

        bucketConfig = oss2.models.BucketCreateConfig(oss2.BUCKET_STORAGE_CLASS_STANDARD)
        resp = bucket.create_bucket(oss2.BUCKET_ACL_PRIVATE, bucketConfig)
        if resp.status == 200:
            output.success(f"create {args.bucket_name} success")

        return result
