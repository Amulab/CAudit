import argparse
import random
import time
from copy import copy

import oss2
import requests
from prettytable import PrettyTable

from plugins.AliCloud import PluginAliCloudBase, AliCloud
from plugins.AliCloud.Plugin_AliCloud_Exploit_ListBuckets import PluginAliCloudListBuckets
from plugins.AliCloud.Plugin_AliCloud_Exploit_ListECS import PluginAliCloudListECS
from plugins.AliCloud.Plugin_AliCloud_Exploit_ListRDS import PluginAliCloudListRDS
from utils import output
from utils.consts import AllPluginTypes


class PluginAliCloudGetAllService(PluginAliCloudBase):
    display = "列出所有服务"
    alias = "get_all_svc"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display
        parser.add_argument("-a", "--access-key", required=True, help="access key", dest="access_key")
        parser.add_argument("-s", "--secret-key", required=True, help="secret key", dest="secret_key")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        output.info("Listing Buckets")
        buckets = PluginAliCloudListBuckets()
        buckets.run_script(args)

        output.info("Listing ECS")
        ecs = PluginAliCloudListECS()
        ecs.run_script(args)

        output.info("Listing RDS")
        rds = PluginAliCloudListRDS()
        rds.run_script(args)

        return result
