import argparse
import random
from copy import copy

import requests
from prettytable import PrettyTable

from plugins.AliCloud import PluginAliCloudBase, AliCloud
from utils import output
from utils.consts import AllPluginTypes


class PluginAliCloudGetUserPolicies(PluginAliCloudBase):
    display = "列出当前凭证权限"
    alias = "ali_get_perm"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display
        parser.add_argument("-a", "--access-key", required=True, help="access key", dest="access_key")
        parser.add_argument("-s", "--secret-key", required=True, help="secret key", dest="secret_key")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        result_table = PrettyTable(["POLICY NAME", "DESCRIPTION"])
        result_table.align["POLICY NAME"] = "l"
        result_table.align["DESCRIPTION"] = "l"
        result_table.border = False

        ak = args.access_key
        sk = args.secret_key

        al = AliCloud(ak,sk)
        current_user = al.getkeyuser()

        if "root" in current_user:
            result_table.add_row(["AdministratorAccess", "管理所有阿里云资源的权限"])
        else:
            p = al.listpoliciesforuser(current_user)
            if p is not None:
                for policy in p:
                    result_table.add_row([policy["PolicyName"], policy["Description"]])

        output.success(f"result:\n"
                       f"{result_table}")
        return result
