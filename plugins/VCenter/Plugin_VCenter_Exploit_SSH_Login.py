import argparse
from copy import copy

from plugins.VCenter import PluginVCenterBase
from utils import output
from utils.consts import AllPluginTypes


class PluginVCenterSSHLogin(PluginVCenterBase):
    display = "ssh login"
    alias = "ssh_login"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument("-i", "--ip", help="target ip address.(192.168.1.1)", required=True, dest="address")
        parser.add_argument("-u", "--username", help="ssh username", required=True, dest="username")
        parser.add_argument("-p", "--password", help="ssh password", required=True, dest="password")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        try:
            host = args.address
            username = args.username
            passwd = args.password
            from paramiko.client import SSHClient
            import paramiko
            client = SSHClient()
            client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            client.connect(host, username=username, password=passwd)
            _stdin, _stdout, _stderr = client.exec_command("shell whoami")
            output.info(_stdout.read().decode())
            client.close()
        except Exception as e:
            output.error(e)

        return result
