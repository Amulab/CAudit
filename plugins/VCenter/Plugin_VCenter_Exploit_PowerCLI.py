import argparse
from base64 import b64encode
from copy import copy

from plugins.VCenter import PluginVCenterBase
from utils import output
from utils.consts import AllPluginTypes


class PluginVCenterxx(PluginVCenterBase):
    display = "xx"
    alias = "xx"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument("-i", "--ip", help="target ip address.(192.168.1.1)", dest="address")
        parser.add_argument("-u", "--ldap-user", help="ldap user", dest="ldap_user")
        parser.add_argument("-p", "--ldap-pass", help="ldap pass", dest="ldap_pass")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        ip = args.address
        username = args.ldap_user
        password = args.ldap_pass

        def dn2upn(dn: str):
            dn_parts = dn.split(',')
            name = dn_parts[0].split('=')[1]
            domain = '.'.join([part.split('=')[1] for part in dn_parts[1:] if 'dc=' in part])
            return f'{name}@{domain}'

        import subprocess
        server = ip
        ldap_user = username
        user = dn2upn(ldap_user)
        cmd = f'Connect-VIServer -Server {server} -Protocol https -User {user} -Password {password} -Force'
        cmd = cmd.encode('utf_16_le')
        # 6.7.0 测试用户名参数需要用UPN格式， DN格式会报错
        with subprocess.Popen(["powershell", "-encodedCommand", b64encode(cmd).decode()],
                              stdout=subprocess.PIPE) as proc:
            # pass
            output.info(proc.stdout.read().decode('gbk'))
        return result
