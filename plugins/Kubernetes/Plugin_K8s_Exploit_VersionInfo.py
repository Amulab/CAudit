import argparse
import json
from copy import copy

import requests
import urllib3

from plugins.Kubernetes import PluginKubernetesBase
from utils import output
from utils.consts import AllPluginTypes
urllib3.disable_warnings()


class PluginK8sVersionInfo(PluginKubernetesBase):
    display = "k8s 版本探测"
    alias = "version_info"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument("-i", "--ip", help="target ip address.(192.168.1.1)", required=True, dest="ip")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        ip = args.ip

        r = requests.get(f"https://{ip}:6443/version", allow_redirects=False, verify=False)
        if r.status_code == 200:
            text = f"{r.status_code}\n"
            for k, v in json.loads((r.text)).items():
                text += f"{'':^4}{k:<15}{v}\n"
            output.success(text)

        return result
