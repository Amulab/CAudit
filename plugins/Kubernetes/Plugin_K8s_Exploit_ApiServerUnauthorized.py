import argparse
from copy import copy

import requests

from plugins.Kubernetes import PluginKubernetesBase
from utils import output
from utils.consts import AllPluginTypes


class PluginK8sApiServerUnauthorized(PluginKubernetesBase):
    display = "k8s ApiServer 未授权访问"
    alias = "api_unauth"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument("-i", "--ip", help="target ip address.(192.168.1.1)", dest="ip")
        parser.add_argument("-p", "--port", help="target port. default 8080", default=8080, dest="port")

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        ip = args.ip
        port = args.port

        r = requests.get(f"https://{ip}:{port}", allow_redirects=False, verify=False)
        if r.status_code == 200:
            output.success(f"{r.status_code}\n"
                           f"{r.text}")

        return result
